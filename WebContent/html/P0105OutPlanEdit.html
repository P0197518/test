<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
    <title>出货计划作成</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <script src="../boot.js" type="text/javascript"></script>
</head>

<div class="edit-page-content">
    <div id="form1" class="form-horizontal" style="width: 100%; min-width: 800px;">
        <input id="id" class="mini-hidden" />
        <input id="mode" class="mini-hidden" />
        <div>
            <div class="tab-content profile-edit-tab-content">
                <div id="edit-basic" class="tab-pane in active">
                    <h4 class="header blue bolder smaller">基本信息</h4>
                    <div class="vspace-12-sm"></div>
                    <div class="space-4"></div>

                    <div class="form-group">
                        <label class="col-sm-1 control-label no-padding-right" for="form-field-username">收货客户:</label>
                        <div class="col-sm-4">
                            <input id="supplierNo" class="mini-textbox" style="width: 50px;" vtype="half:40" maxlength=40 required="true" />
                            <a class="mini-button btn btn-info btn-round" type="button" onclick="customChoose()" onenter="onOk()" />
                            <i class="ace-icon fa fa-search"> </i>
                            </a>
                            <input name="supplierName" id="supplierName" class="mini-textbox" value="" enabled="false" vtype="maxLength:30" required="true" requiredErrorText="不能为空" onenter="onOk()" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-1 control-label" for="form-field-username">收货地址:</label>
                        <div class="col-sm-3">
                            <input id="approval" name="approval" allowinput="true" class="mini-combobox" required="true" valueField="value" textField="text" style="width: 550px;" emptyText="" data='[{value:"01",text:"6番港口"},{value:"02",text:"7番港口"},{value:"04",text:"8番港口"},
                                    {value:"05",text:"4番港口"},{value:"06",text:"5番港口"}]' />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-1" for="form-field-username">计划出货日:</label>
                        <div class="col-sm-3">
                            <input id="dateFeom" name="dateFeom" value="" class="mini-datepicker" datePickerTo="dateTo" format="yyyy/MM/dd" required allowInput="true" showTime="false" showTodayButton="true" onenter="search()" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-1 control-label" for="form-field-username">INVOICE NO:</label>
                        <div class="col-sm-3">
                            <input name="supplierName" id="supplierName" class="mini-textbox" value="" vtype="maxLength:30" onenter="onOk()" />
                        </div>
                        <label class="col-sm-1 control-label" for="form-field-username">BL NO:</label>
                        <div class="col-sm-3">
                            <input name="supplierName" id="supplierName" class="mini-textbox" value="" vtype="maxLength:30" onenter="onOk()" />
                        </div>
                    </div>
                    <div class="form-group">

                        <label class="col-sm-1 control-label" for="form-field-username">海运区分:</label>
                        <div class="col-sm-3">
                            <input id="approval" name="approval" class="mini-combobox" valueField="value" textField="text" emptyText="" data='[{value:"01",text:"BAF"},{value:"02",text:"EBS"}  ]' />
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-1 control-label" for="form-field-username">备注:</label>
                        <div class="col-sm-6">
                            <input name="remarks" id="remarks" class="mini-textarea" value="" width="100%" vtype="maxLength:30" onenter="onOk()" />
                        </div>

                    </div>

                    <div class="space-4"></div>
                    <h4 class="header blue bolder smaller">待出货订单列表</h4>
                    <div class="vspace-12-sm"></div>
                    <div class="space-4"></div>
                    <div class="mini-toolbar">
                        <table style="width:100%;">
                            <tr>
                                <td style="width:100%;">
                                    <div class="search-item">
                                        <label for="name" class="col-sm-1 control-label">青岛出货日:</label>
                                        <input id="dateFeom" name="dateFeom" value="" style="width:100px;" class="mini-datepicker" datePickerTo="dateTo" format="yyyy/MM/dd" allowInput="true" showTime="false" showTodayButton="true" onenter="search()" />
                                        <label for="isusedate" class="control-label"> ～ </label>
                                        <input id="dateTo" name="dateTo" value="" style="width:100px;" class="mini-datepicker" datePickerFrom="dateFeom" showTime="false" format="yyyy/MM/dd" allowInput="true" showTodayButton="true" onenter="search()" />

                                    </div>
                                    <div class="search-item">
                                        <label class="col-sm-1 control-label" for="form-field-username">品番:</label>
                                        <input id="productno" onvaluechanged="productnoChange" style="width:100px;" class="mini-textbox" vtype="halfonly" maxlength=40 required="false" />
                                    </div>

                                    <div class="search-item">
                                        <label class="col-sm-1 control-label" for="form-field-username">图纸编号:</label>
                                        <input id="productno" onvaluechanged="productnoChange" style="width:100px;" class="mini-textbox" vtype="halfonly" maxlength=40 required="false" />
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <div class="">

                        <div id="grid1" class="mini-datagrid" idField="id" multiSelect="true" resultAsData="true" showPager="false" allowCellSelect="true" ondrawcell="onDrawCell" oncellcommitedit="onCellCommitEdit">
                            <div property="columns">
                                <div type="checkcolumn"></div>
                                <div field="orderNo" width="100" headerAlign="center" sortField="productnum" allowSort="false" align="center">订单号</div>
                                <div field="materialName" width="150" headerAlign="center" sortField="orderoutcount" allowSort="false" align="center">品名</div>
                                <div field="texture" width="80" headerAlign="center" sortField="productnum" allowSort="false" align="center">材质</div>
                                <div field="drawingNo" width="80" headerAlign="center" sortField="productnum" allowSort="false" align="center">图纸编号</div>
                                <div field="productNo" width="100" headerAlign="center" sortField="productnum" allowSort="false" align="center">品番</div>
                                <div field="orderCount" width="80" headerAlign="center" sortField="productnum" allowSort="false" align="right">订单数量</div>
                                <div field="prodCount" width="80" headerAlign="center" sortField="productnum" allowSort="false" align="right">可用数量</div>
                                <div field="outCount" width="80" headerAlign="center" sortField="productnum" allowSort="false" align="right">已出库数</div>
                                <div field="nowCount" width="80" headerAlign="center" sortField="productnum" allowSort="false" align="right">应该出库数</div>
                                <div field="priceF" width="80" headerAlign="center" sortField="productname" allowSort="false" datatype="currency" align="right"> 单价JPY</div>
                                <div field="price" width="80" headerAlign="center" sortField="productname" allowSort="false" datatype="currency" align="right"> 单价RMB</div>
                                <div field="totalMoneyF" width="80" headerAlign="center" sortField="productname" allowSort="false" datatype="currency" align="right">金额小计JPY</div>
                                <div field="totalMoney" width="80" headerAlign="center" sortField="productname" allowSort="false" datatype="currency" align="right">金额小计RMB</div>
                            </div>
                        </div>

                        <div class="mini-toolbar">
                            <table style="width:100%;">
                                <tr>
                                    <td style="width:100%;">
                                        <a name="btnAdd" class="mini-button btn btn-warning btn-round" onclick="addAll()" type="button">
                                            <i class="ace-icon fa fa-angle-double-down"> </i>加入出库
                                        </a>
                                        <a class="mini-button btn btn-danger btn-round" onclick="removes()">
                                            <i class="ace-icon fa fa-angle-double-up"> </i> 删除
                                        </a>
                                    </td>
                                </tr>
                            </table>
                        </div>

                        <div class="">

                            <div id="grid2" class="mini-datagrid" idField="id" multiSelect="true" showPager="false" allowCellEdit="true" allowCellSelect="true" ondrawsummarycell="onDrawSummaryCell">
                                <div property="columns">
                                    <div type="checkcolumn"></div>
                                    <div field="orderNo" width="100" headerAlign="center" sortField="productnum" allowSort="false" align="center">订单号</div>
                                    <div field="materialName" width="150" headerAlign="center" sortField="orderoutcount" allowSort="false" align="center">品名</div>
                                    <div field="texture" width="80" headerAlign="center" sortField="productnum" allowSort="false" align="center">材质</div>
                                    <div field="drawingNo" width="80" headerAlign="center" sortField="productnum" allowSort="false" align="center">图纸编号</div>
                                    <div field="productNo" width="100" headerAlign="center" sortField="productnum" allowSort="false" align="center">品番</div>
                                    <div field="lotNo" width="80" headerAlign="center" sortField="productnum" allowSort="false" align="center">LotNo</div>
                                    <div field="orderCount" width="80" headerAlign="center" sortField="productnum" allowSort="false" align="right">订单数量</div>
                                    <div field="nowCount" width="80" headerAlign="center" sortField="Outgoingstock" allowSort="false" align="right">
                                        出库数&nbsp;<i class="ace-icon fa fa-pencil-square-o"></i>
                                        <input property="editor" class="mini-textbox" style="width:100%;" />
                                    </div>
                                    <div field="priceF" width="80" headerAlign="center" sortField="productname" allowSort="false" datatype="currency" align="right"> 单价JPY</div>
                                    <div field="price" width="80" headerAlign="center" sortField="productname" allowSort="false" datatype="currency" align="right"> 单价RMB</div>
                                    <div field="totalMoneyF" width="80" headerAlign="center" sortField="productname" allowSort="false" datatype="currency" align="right">金额小计JPY</div>
                                    <div field="totalMoney" width="80" headerAlign="center" sortField="productname" allowSort="false" datatype="currency" align="right">金额小计RMB</div>
                                </div>
                            </div>
                        </div>


                        <div class="form-group" style="margin-top: 10px;">

                            <label class="control-labelt" style="margin-left: 20px;">数量合计:</label>

                            <input id="totalCaseCount" class="mini-textbox" vtype="half:40" maxlength=40 required="false" datatype="currency" enabled="false" />

                            <label class="control-label" style="margin-left: 20px;">金额合计JPY:</label>

                            <input id="totalMoneyF" class="mini-textbox" vtype="half:40" maxlength=40 required="false" datatype="currency" enabled="false" />
                            <label class="control-label" style="margin-left: 20px;">金额合计RMB:</label>

                            <input id="totalMoney" class="mini-textbox" vtype="half:40" maxlength=40 required="false" datatype="currency" enabled="false" />


                        </div>
                    </div>
                </div>
            </div>

            <div style="text-align: center; padding: 10px;">
                <a class="mini-button btn btn-info btn-round " onclick="onOk()" type="button">
                    <i class="ace-icon fa fa-floppy-o bigger-110"></i> 确 定
                </a> &nbsp; &nbsp;
                <a class="mini-button btn btn-warning btn-round" onclick="onCancel()" type="button">
                    <i class="ace-icon fa fa-undo bigger-110"></i> 取 消
                </a>
            </div>
        </div>
    </div>
    <!-- /.page-content -->

    <script type="text/javascript">
        var form = new mini.Form("#form1");
        mini.parse();
        var grid = mini.get("grid1");


        mini.parse();
        var grid2 = mini.get("grid2");

        function productnoChange() {
            search();
        }

        function addAll() {
            var items = []

            for (var i = 0; i < grid.data.length; i++) {
                if (grid.getData()[i].nowCount != 0 && grid.getData()[i].nowCount != null) {
                    //  grid.getData()[i].ordernum = ordernum;
                    items.push(grid.getData()[i])
                }
            }
            grid2.addRows(items);
        }

        function removes() {
            var items = grid2.getSelecteds();
            grid2.removeRows(items);
        }

        function saveData() {
            var data = grid2.getData();
            var json = mini.encode(data);
            alert(json);
        }
        // 查询操作
        function search() {

            //			var searchcondation = getJsonObject("searchCondation");
            //			
            //			grid.load({ id: form.getData().id });
            //			
            var gridData = new Array();
            for (var i = 0; i < 5; i++) {
                gridData.push({
                    orderNo: "P9Y328137" + i,
                    drawingNo: "E-1160",
                    texture: "TE60",
                    materialName: "CH-40KIRS-B-CE(TE60)",
                    productNo: "E-1160-TE60",
                    lotNo: "VL-16" + i,
                    orderCount: 100,
                    prodCount: 0,
                    outCount: 50,
                    nowCount: 50,
                    priceF: 1000,
                    price: 60,
                    totalMoneyF: 50 * 1000,
                    totalMoney: 50 * 60

                });
            }
            grid.setData(gridData);
        }



        // 页面初期化制御
        function onload(flg) {
            if (flg == 1) {
                mini.get("username").enable();
            } else {
                mini.get("username").disable();
            }
        }

        // 保存操作
        function onOk() {
            // form.validate();
            // if (form.isValid() == false) {
            //     businessMessage.alert("E0009");
            //     return;
            // }
            // businessMessage.alert("Q0002", null, oksave);
        }

        function oksave() {
            // var data = form.getData();
            // data.deliveryaddress = grid.data;
            // var accessurl = "";
            // if (mini.get("mode").value == "2") {
            //     accessurl = "/S9910Customs/add";
            // } else {
            //     accessurl = "/S9910Customs/update";
            // }
            // doAjax(accessurl, data, function(obj) {
            //     if (obj.status == "SUCCESS") {
            //         businessMessage.alert("I0001", null, function() {
            //             CloseWindow("ok");
            //         });
            //     } else if (obj.message == "E0024") {
            //         businessMessage.alert(obj.text);
            //         return;
            //     }
            // });
        }

        //初始化时focus
        function loadfocus() {
            mini.get("supplierNo").focus();
        }

        function addRow() {
            var newRow = {
                name: "New Row"
            };
            grid.addRow(newRow, grid.getData().length);

            grid.beginEditCell(newRow, "LoginName");
        }

        function removeRow() {
            var rows = grid.getSelecteds();
            if (rows.length > 0) {

                grid.removeRows(rows, true);
            }
        }

        grid.on("celleditenter", function(e) {
            var index = grid.indexOf(e.record);
            if (index == grid.getData().length - 1) {
                var row = {};
                grid.addRow(row);
            }
        });

        grid.on("beforeload", function(e) {
            if (grid.getChanges().length > 0) {
                if (confirm("有增删改的数据未保存，是否取消本次操作？")) {
                    e.cancel = true;
                }
            }
        });

        // 
        function customChoose() {
            var popWindow = {
                url: "P0704CustomList.html",
                title: "客户选择",
                width: 1000,
                height: 500,
                onload: function() {},
                ondestroy: function(action) {}
            };
            mini.open(popWindow);
        }


        function supplierSelected(data) {
            mini.get("supplierNo").setValue(data.id);
            mini.get("supplierName").setValue(data.name);
            mini.get("address").setValue(data.address);
            mini.get("telephone").setValue(data.telephone);
            mini.get("email").setValue(data.email);
            mini.get("fax").setValue(data.fax);
            grid.clearRows();
            search();
        }

        //提交单元格编辑数据前激发
        function onCellCommitEdit(e) {
            var editor = e.editor;

            editor.validate();
            if (editor.isValid() == false) {
                alert(editor.getErrorText());
                e.cancel = true;
            }
        }

        function onDrawCell(e) {
            var record = e.record;

            if (e.field == "money") {
                // 計算合計額金額
                var shipped = record.shipped;
                var price = record.price;
                var money = shipped * price;
                e.cellHtml = money;
                record.money = money;
            }

        }


        function onDrawSummaryCell(e) {
            var result = e.result;
            var grid = e.sender;
            var rows = e.data;

            if (e.field == "money") {
                var money = 0;
                for (var i = 0, l = rows.length; i < l; i++) {
                    var row = rows[i];
                    money += row.money;
                }
                mini.get("totalMoney").setValue(money);
            }
        }

        function promptClick() {
            addAll();

        }
    </script>
    </body>

</html>