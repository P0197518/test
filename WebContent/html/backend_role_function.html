<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <title>资源列表</title>
    <script src="../boot.js" type="text/javascript"></script>
    <style>
        .function-item {
            margin-left: 5px;
            margin-right: 5px;
        }
        
        .function-item input {
            vertical-align: bottom;
        }
    </style>
</head>

<body onload="loadfocus()">

    <div class="edit-page-content">
        <div id="form" class="form-horizontal" style="width:100%;min-width:800px;">
            <input name="id" id="id" class="mini-hidden" value="${resource.id}" />
            <input name="oldresourcename" id="oldresourcename" class="mini-hidden" value="${resource.resourcename }" />
            <input name="version" id="version" class="mini-hidden" value="${resource.version }" />
            <input name="type" id="type" class="mini-hidden" value="MENU" />
            <div>
                <div class="tab-content profile-edit-tab-content">
                    <div id="edit-basic" class="tab-pane in active">
                        <h4 class="header blue bolder smaller">角色信息</h4>

                        <div class="vspace-12-sm"></div>

                        <div class="form-group">
                            <label class="col-sm-1 control-label no-padding-right" for="form-field-username">角色名称:</label>

                            <div class="col-sm-2">
                                <input id="rname" class="mini-textbox" style="width:150px;" vtype="maxLength:30" value="" onenter="onOk()" required="true" requiredErrorText="不能为空" />
                            </div>

                            <label class="col-sm-1 control-label no-padding-right" for="form-field-username">描述：</label>

                            <div class="col-sm-2">
                                <input id="desc" class="mini-textbox" style="width:150px;" vtype="maxLength:50" onenter="onOk()" value="" />
                            </div>

                            <!-- 	<label class="col-sm-1 control-label no-padding-right" for="form-field-username">是否公司角色：</label>

							<div class="col-sm-3">
          						<input id="istocompany" name="istocompany" class="mini-radiobuttonlist" textField="text" valueField="id" value="" data="[{id:true,text:'是'},{id:false,text:'否'}]" /> 
							</div> -->
                        </div>

                        <h4 class="header blue bolder smaller"></h4>

                        <div class="vspace-12-sm"></div>

                        <div class="form-group">
                            <div id="treegrid1" class="mini-treegrid" style="width:100%;height:400px;" url="deptTree.txt" treeColumn="name" idField="id" parentField="pid" resultAsTree="false" allowResize="false" expandOnLoad="true" showTreeIcon="true" allowSelect="false" allowCellSelect="false"
                                enableHotTrack="false" ondrawcell="ondrawcell">

                                <div property="columns">
                                    <div type="indexcolumn"></div>
                                    <div name="name" field="name" width="120">模块名称</div>
                                    <div field="functions" width="100%">权限</div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div style="text-align:center;padding:10px;">
                <a class="mini-button btn btn-info btn-round " onclick="onOk()" type="button">
                    <i class="ace-icon fa fa-floppy-o bigger-110"></i> 确 定
                </a> &nbsp; &nbsp;
                <a class="mini-button btn btn-warning btn-round" onclick="onCancel()" type="button">
                    <i class="ace-icon fa fa-undo bigger-110"></i> 关 闭
                </a>
            </div>
        </div>
    </div>
    <!-- /.page-content -->

</body>

</html>
<script>
    //enter快捷键
    $(function() {
        $(document).keydown(function(e) {
            if (e.keyCode == 13) {
                onOk();
            }
        });
    });
    mini.parse();
    var tree = mini.get("treegrid1");
    var showAllSelect = true;

    function ondrawcell(e) {
        var tree = e.sender,
            record = e.record,
            field = e.field,
            id = record[tree.getIdField()],
            funs = record.functions;

        function createCheckboxs(funs) {
            if (!funs) return "";
            var html = "";
            if (showAllSelect) {
                var value = record.checkAll !== false ? "全选" : "取消";

                var clickFn = 'checkAllFunc(\'' + id + '\', this)';
                html += '<input onclick="' + clickFn + '" type="button" value="' + value + '" style="border:solid 1px #aaa;"/>';
            }
            for (var i = 0, l = funs.length; i < l; i++) {
                var fn = funs[i];
                var clickFn = 'checkFunc(\'' + id + '\',\'' + fn.action + '\', this.checked)';
                var checked = fn.checked ? 'checked' : '';
                html += '<label class="function-item"><input onclick="' + clickFn + '" ' + checked + ' type="checkbox" name="' +
                    fn.action + '" hideFocus/>' + fn.name + '</label>';
            }
            return html;
        }

        if (field == 'functions') {
            e.cellHtml = createCheckboxs(funs);
        }
    }

    function getFuns() {
        var data = tree.getData();
        var json = mini.encode(data);
        alert(json);
    }

    function checkFunc(id, action, checked) {
        var record = tree.getRecord(id);
        if (!record) return;
        var funs = record.functions;
        if (!funs) return;

        function getAction(action) {
            for (var i = 0, l = funs.length; i < l; i++) {
                var o = funs[i];
                if (o.action == action) return o;
            }
        }
        var obj = getAction(action);
        if (!obj) return;
        obj.checked = checked;
    }

    function checkAllFunc(id, btn) {
        var record = tree.getRecord(id);
        if (!record) return;
        var funs = record.functions;
        if (!funs) return;


        var checked = record.checkAll !== false;

        for (var i = 0, l = funs.length; i < l; i++) {
            var o = funs[i];
            o.checked = checked;
        }

        record.checkAll = !checked;
        tree.updateRow(record);

    }
    //////////////////////////////////////////////////////////////////////////////////////
    function onOk() {

        var form = new mini.Form("form");
        form.validate();
        if (form.isValid() == false) return;

        var data = tree.getData(false, false);
        //// alert(data)
        //  var child = data.getChildren();
        var json = mini.encode(data);

        //form.loading();
        $.ajax({
            url: "../system/backend_role!save.action",
            type: "post",
            data: {
                data: json,
                name: mini.get("rname").getValue(),
                desc: mini.get("desc").getValue(),
                id: "${id}",
                istocompany: mini.get("istocompany").getValue()
            },
            success: function(text) {
                if (text == "success") {
                    $(document).keydown(function(e) {
                        if (e.keyCode == 32) {
                            CloseWindow();
                        }
                    });
                    mini.alert("保存成功!", "提示", function() {
                        CloseWindow();
                    });
                } else {
                    mini.alert(text);
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                mini.alert(jqXHR.responseText);
            }
        });
    }
    //////////////////////////////////////////////////////////////////////////////////////
    function CloseWindow(action) {
        if (window.CloseOwnerWindow)
            return window.CloseOwnerWindow(action);
        else
            window.close();
    }

    function onCancel() {
        CloseWindow("cancel");
    }
    // 初始化时focus
    function loadfocus() {
        mini.get("rname").focus();
    }
</script>